import os
import hashlib
import concurrent.futures
import sys
import logging
import requests
import tkinter as tk
from tkinter import messagebox

BUFFER_SIZE = 65536
SELECTED_EXTS = ['.py', '.exe', '.dll', '.bat']

class Antivirus:
    def __init__(self, malicious_hashes, max_workers=4):
        self.malicious_hashes = malicious_hashes
        self.max_workers = max_workers
        self.logger = logging.getLogger(__name__)
        self.logger.setLevel(logging.DEBUG)  # Set to DEBUG during development
        self.file_handler = logging.FileHandler('antivirus.log')
        self.logger.addHandler(self.file_handler)
        self.virus_database = set()  # Database for known malware hashes
        self.load_known_malware_database()  # Load known malware hashes from a file

    def load_known_malware_database(self):
        # Load known malware hashes from a file into the database
        with open('known_malware_hashes.txt', 'r') as f:
            for line in f:
                self.virus_database.add(line.strip())

    @staticmethod
    def calculate_checksum(filename):
        try:
            with open(filename, 'rb') as f:
                hash_obj = hashlib.sha256()
                while True:
                    buf = f.read(BUFFER_SIZE)
                    if not buf:
                        break
                    hash_obj.update(buf)
                return hash_obj.hexdigest()
        except FileNotFoundError:
            return None

    def check_known_malware(self, file_checksum):
        # Check if the file's hash is in the known malware database
        return file_checksum in self.virus_database

    def scan_file(self, filename):
        try:
            file_checksum = self.calculate_checksum(filename)
            if file_checksum and self.check_known_malware(file_checksum):
                self.logger.info(f"File {filename} is infected.")
                self.show_notification(f"Infected file detected: {filename}")
                return filename, True
            return filename, False
        except Exception as e:
            self.logger.error(f"An error occurred while scanning {filename}: {e}")
            return filename, False

    def scan_directory(self, directory):
        infected_files = []
        files_to_scan = [file.path for file in os.scandir(directory) if file.is_file() and os.path.splitext(file.name)[1].lower() in SELECTED_EXTS]
        with concurrent.futures.ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            results = [executor.submit(self.scan_file, file) for file in files_to_scan]
            for result in concurrent.futures.as_completed(results):
                if result.result()[1]:
                    infected_files.append(result.result()[0])
        return infected_files

    def show_notification(self, message):
        # Display a pop-up notification
        root = tk.Tk()
        root.withdraw()
        messagebox.showinfo("Antivirus Notification", message)

if __name__ == '__main__':
    # Read malicious hashes from a file (replace the URL with your actual URL)
    malicious_hashes_file = "https://raw.githubusercontent.com/Bassceecruz/malware_detector/main/bughacker-hashes.txt"
    with requests.get(malicious_hashes_file) as response:
        malicious_hashes = set(response.text.splitlines())

    if not malicious_hashes:
        print("Malicious hashes not available. Exiting.")
        sys.exit(1)

    if not os.path.exists('known_malware_hashes.txt'):
        with open('known_malware_hashes.txt', 'w'):
            pass

    # User input for scanning preferences
    scan_option = input("Enter 'D' to scan a specific directory: ").upper()

    if scan_option == 'D':
        directory_to_scan = input("Enter the path of the directory to scan: ")
    else:
        print("Invalid option. Exiting.")
        sys.exit(1)

    antivirus = Antivirus(malicious_hashes)

    infected_files = antivirus.scan_directory(directory_to_scan)

    if infected_files:
        print("Infected files:")
        for file in infected_files:
            print(file)
    else:
        print("No infected files found.")

